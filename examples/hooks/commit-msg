#!/bin/bash
# nomoji.dev commit-msg hook
# Place in .git/hooks/commit-msg and chmod +x

set -e

NOMOJI_API="https://nomoji.dev/api"
USER_ID="${NOMOJI_USER_ID:-default}"

# Read commit message
commit_msg=$(cat "$1")

echo "nomoji.dev: Checking commit message for emojis..."

# Analyze commit message
result=$(curl -s -X POST "$NOMOJI_API/analyze" \
  -H "Content-Type: application/json" \
  -d "{\"text\":\"$commit_msg\"}" 2>/dev/null)

# Check if request was successful
if [ $? -ne 0 ]; then
  echo "Warning: Failed to check commit message (API request failed)"
  exit 0
fi

# Parse result
has_emojis=$(echo "$result" | jq -r '.data.hasEmojis' 2>/dev/null)

if [ "$has_emojis" = "true" ]; then
  emoji_count=$(echo "$result" | jq -r '.data.count')
  unique_emojis=$(echo "$result" | jq -r '.data.unique | join(", ")')
  
  echo ""
  echo "=================================="
  echo "❌ COMMIT MESSAGE REJECTED"
  echo "=================================="
  echo "Your commit message contains $emoji_count emoji(s): $unique_emojis"
  echo ""
  echo "Please write commit messages without emojis."
  echo "Use conventional commit format:"
  echo "  feat: add new feature"
  echo "  fix: resolve bug in component"
  echo "  docs: update README"
  echo ""
  echo "To bypass this check (not recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
else
  echo "✓ Commit message is emoji-free"
  exit 0
fi

